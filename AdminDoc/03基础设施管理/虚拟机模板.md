**虚拟机模板**

虚拟机模板是操作系统的抽象和标准化。平台支持创建虚拟机模板，一个操作系统可对应多个虚拟机模板。
+ 虚拟机模板与云平台中的模板或镜像相关联，例如：vSphere vCenter中的模板、OpenStack平台上的镜像、公有云平台各个区域的操作系统（OS）镜像。

+ 在虚拟机模板中可配置SmartCMP两种代理的安装方式和账号信息，这两种代理是监控代理和自动化代理。

SmartCMP一些自动化功能依赖自动化代理，例如：

-   蓝图带应用部署或添加磁盘

-   服务配置初始化并挂载磁盘、创建新用户

-   部分虚机运维操作（包括重置密码，执行脚本，应用启动停止，添加、扩展Linux逻辑卷或Windows磁盘等）。

创建虚拟机模板后，可在服务配置中直接指定。SmartCMP可根据蓝图对象所在的云平台自动识别虚拟机模板。

>「Note」请使用租户管理员或基础设施管理员角色登录SmartCMP平台。租户管理员可为某用户指定基础设施管理员角色。系统默认创建了3个虚拟机模板：Windows2012 R2、Redhat 7、CentOS7，还需添加相应的云平台信息才可使用。下文为您介绍添加虚拟机模板。

# 添加虚拟机模板

这里定义两个虚拟机模板：Windows 2012 R2和CentOS 7：

## 添加Linux虚拟机模板 

1.  选择「基础设施」-「虚拟机模板」，进入虚拟机模板列表界面。点击「添加」，输入操作系统名称，描述，选择系统类型Linux，点击「提交」

2.  点击「虚拟机模板」标签页，进入虚拟机模板列表界面

### 添加vSphere虚拟机模板{#添加vSphere虚拟机模板}

在虚拟机模板列表界面，点击「添加」，输入虚拟机模板名称，选择一个vSphere云平台并做如下配置：

克隆模式：「完全克隆」或「链接克隆」

 >「Note」完全克隆是和原始虚拟机完全独立的一个拷贝，它不和原始虚拟机共享任何资源，可以脱离原始虚拟机独立使用；链接克隆需要和原始虚拟机共享同一虚拟磁盘文件，不能脱离原始虚拟机独立运行。但采用共享磁盘文件却大大缩短了创建克隆虚拟机的时间，同时还节省了宝贵的物理磁盘空间。

- 完全克隆：  模板：选择一个Linux CentOS模板

- 链接克隆： 虚拟机：选择一个Linux CentOS 7的模板。 快照模式：默认"指定一个快照"，可选择"申请时候选择"和"总是使用最新"这两种快照模式。选择"申请时候选择"将在服务申请的时候选择虚拟机快照。 快照：若快照模式选择"指定一个快照"，将选择一个快照。 使用规范：选择「内建」

>（按需求选择无、内建或自定义规范，规范有助于防止在部署相同设置的虚机时产生冲突）

-   模板中已启用SSH：勾选该选项，表示模板中已经启用和配置SSH，可以选择通过SSH的方式安装监控代理和自动化代理；默认SSH端口为22，如果模板中修改了SSH的端口，可输入模板中修改的SSH端口号

-   用户名、密码：使用具有SSH权限的用户及其密码

-   安装监控代理：
> 无监控：若不安装监控代理，则平台的监控功能不可用。SSH安装监控代理：选择SSH安装的话，会通过SSH的方式访问虚拟机并安装监控代理；设置监控端口，默认是9100。预安装监控代理：预安装是指模板中已经安装了监控代理。云平台监控：从VCenter上直接读取虚机的监控数据，不需要安装监控代理

-   安装自动化代理：不安装：若不安装自动化代理，则平台的一些自动化功能将无法使用，例如蓝图带应用部署或添加磁盘，某些虚拟机的操作如重置密码，执行脚本等等。SSH安装：选择SSH安装，会通过SSH的方式访问虚拟机并安装自动化代理。预安装：预安装是指模板中已经安装了自动化代理

<!-- -->

-   管理员用户：输入模板中配置的管理员用户名

-   管理员密码：输入模板中配置的管理员密码

2.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新

### 添加OpenStack虚拟机模板{#添加OpenStack虚拟机模板}

1.  在虚拟机模板页面，点击「添加」，输入虚拟机模板名称，选择一个OpenStack云平台并做如下配置：

-   启动源类型：从镜像启动、从快照启动、从云硬盘启动、从云硬盘快照启动


-   从镜像启动：选择镜像名称和快照模式；快照模式默认为"不使用快照"，可选择"申请时候选择"和"总是使用最新的"。若选择"申请时候选择"将在服务申请时指定虚拟机快照

-   从快照启动：选择快照名称

-   从云硬盘启动：选择镜像名称和快照模式；快照模式默认为"不使用快照"，可选择"申请时候选择"和"总是使用最新的"。若选择"申请时候选择"将在服务申请时指定虚拟机快照；若勾选"终止后删除"，将在终止主机后删除硬盘。选择"从云硬盘启动"模式需要在服务配置时选择卷类型和配置卷大小

-   从云硬盘快照启动：选择云硬盘快照名称，若勾选"终止后删除"，将在终止主机后删除硬盘。选择"从云硬盘快照启动"模式需要在服务配置时选择卷类型和配置卷大小

<!-- -->

-   虚拟机镜像：选择一个CentOS的模板

-   安装监控和自动化代理的方式与vSphere的Linux模板相同，可配置SSH端口，此外SSH用户支持密钥方式（可在「基础设施」-「密钥对」中新建密钥或导入密钥）

-   管理员用户名和密码：输入需要设置的操作系统管理员用户名和密码。

2.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新,此时这个Linux CentOS的操作系统，关联了2个虚拟机模板。在[服务配置](https://cloudchef.github.io/doc/AdminDoc/05服务建模/服务配置.html)的时候，平台会自动选择与该服务相对应的虚拟机模板，无需重复设置。

### 添加Hyper-V虚拟机模板{#添加Hyper-V虚拟机模板}

1.  在虚拟机模板页面，点击「添加」，输入虚拟机模板名称，选择HyperV云平台名称，并对虚拟机模板做如下配置：

-   基本信息：选择「操作系统名称」、描述、和系统类型（按需求选择Linux和Windows，这里选择Linux）

-   模板：选择一个CentOS的模板

-   编辑虚拟机模板：输入模板名称、云平台入口、模板中已启用SSH：勾选该选项，表示模板中已经启用和配置SSH（输入模板中配置的SSH端口），可以选择通过SSH方式安装监控代理和自动化代理

-   监控方式：

<!-- -->

-   无监控：不安装监控代理，则平台的监控功能不可用

-   SSH安装监控代理：选择SSH安装的话，会通过SSH的方式访问虚拟机并安装监控代理；设置监控端口，默认是9100

<!-- -->

-   安装自动化代理：

<!-- -->

-   不安装：若不安装自动化代理，则平台的一些自动化功能将无法使用，例如蓝图带应用部署或添加磁盘，某些虚拟机的操作如重置密码，执行脚本等等

-   SSH按照自动化代理：选择SSH安装，会通过SSH的方式访问虚拟机并安装自动化代理

<!-- -->

-   用户名：输入需要设置的用户名，例如: root

-   密码：输入需要设置的管理员密码,例如：Passw0rd

2.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新


### 添加Azure虚拟机模板{#添加Azure虚拟机模板}

  在虚拟机模板页面，点击「添加」，输入虚拟机模板名称，选择Azure云平台名称，并对虚拟机模板做如下配置：

-   基本信息：选择「操作系统名称」、描述、和系统类型（按需求选择Linux和Windows，这里选择Linux）

-   编辑虚拟机模板：输入模板名称、云平台入口、选择区域名称（例如：中国北部）、镜像名称（勾选允许修改时，在服务配置种可以修改镜像）

-   监控方式：

<!-- -->

-   无监控：不安装监控代理，则平台的监控功能不可用

-   SSH安装监控代理：选择SSH安装的话，会通过SSH的方式访问虚拟机并安装监控代理；设置监控端口，默认是9100

-   云平台监控：从Azure云平台直接读取虚机的监控数据，不需要安装监控代理

<!-- -->

-   安装自动化代理：

<!-- -->

-   不安装：若不安装自动化代理，则平台的一些自动化功能将无法使用，例如蓝图带应用部署或添加磁盘，某些虚拟机的操作如重置密码，执行脚本等等

-   SSH按照自动化代理：选择SSH安装，会通过SSH的方式访问虚拟机并安装自动化代理

<!-- -->

-   用户名：输入需要设置的用户名，例如: root

-   密码：输入需要设置的管理员密码,例如：Passw0rd

2.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新

## 添加Windows虚拟机模板 

5.  选择「基础设施」-「虚拟机模板」，进入虚拟机模板列表界面。点击「添加」，输入虚拟机模板名称，描述，选择系统类型：Windows，点击「提交」

6.  点击「虚拟机模板」标签页，进入虚拟机模板列表界面

### 添加一个vSphere虚拟机模板

1.  在虚拟机模板页面，点击「添加」，输入虚拟机模板名称，选择一个vSphere云平台并做如下配置：

-   克隆模式：「完全克隆」「链接克隆」

 >「Note」完全克隆是和原始虚拟机完全独立的一个拷贝，它不和原始虚拟机共享任何资源。可以脱离原始虚拟机独立使用；链接克隆需要和原始虚拟机共享同一虚拟磁盘文件，不能脱离原始虚拟机独立运行。但采用共享磁盘文件却大大缩短了创建克隆虚拟机的时间，同时还节省了宝贵的物理磁盘空间。

-   完全克隆：

<!-- -->

-   模板：选择Windows 2012模板

<!-- -->

-   链接克隆

<!-- -->

-   虚拟机：选择一个Windows 2012的模板

-   快照模式：默认"指定一个快照"，可选择"申请时候选择"和"总是使用最新"这两种快照模式。选择"申请时候选择"将在服务申请的时候选择虚拟机快照

-   快照：若快照模式选择"指定一个快照"，将选择一个快照

<!-- -->

-   使用规范：选择「内建」（按需求选择无、内建或自定义规范，规范有助于防止在部署相同设置的虚机时而产生冲突）

-   模板中已启用WinRM：勾选该选项，表示模板中已经启用和配置WinRM，可以选择通过WinRM的方式安装监控代理和自动化代理

-   监控方式：

<!-- -->

-   无监控：不安装监控代理，则平台的监控功能不可用

-   WinRM安装监控代理：会通过WinRM的方式访问虚拟机并安装监控代理设置监控端口，默认是9182

-   预安装监控代理：指模板中已经安装了监控代理

-   云平台监控：从VCenter上直接读取虚机的监控数据，不需要安装监控代理

<!-- -->

-   安装自动化代理：

<!-- -->

-   不安装：若不安装自动化代理，则平台的一些自动化功能将无法使用，例如蓝图带应用部署或添加磁盘，某些虚拟机的操作如重置密码，执行脚本等等

-   WinRM安装：选择WinRM安装，会通过WinRM的方式访问虚拟机并安装自动化代理

-   预安装：指模板中已经安装了自动化代理

<!-- -->

-   Windows用户名：输入需要设置的Windows管理员用户名

-   Windows密码：输入需要设置的Windows管理员密码

2.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新

### 添加一个OpenStack虚拟机模板

1.  在虚拟机模板页面，点击「添加」，输入虚拟机模板名称，选择一个OpenStack云平台并做如下配置：

-   启动源类型：选择从镜像启动、从快照启动、从云硬盘启动或从云硬盘快照启动

<!-- -->

-   从镜像启动：选择镜像名称和快照模式；快照模式默认为"不使用快照"，可选择"申请时候选择"和"总是使用最新的"。若选择"申请时候选择"将在服务申请时指定虚拟机快照

-   从快照启动：选择快照名称

-   从云硬盘启动：选择镜像名称和快照模式；快照模式默认为"不使用快照"，可选择"申请时候选择"和"总是使用最新的"。若选择"申请时候选择"将在服务申请时指定虚拟机快照；若勾选"终止后删除"，将在终止主机后删除硬盘。选择"从云硬盘启动"模式需要在服务配置时选择卷类型和配置卷大小

-   从云硬盘快照启动：选择云硬盘快照名称，若勾选"终止后删除"，将在终止主机后删除硬盘。选择"从云硬盘快照启动"模式需要在服务配置时选择卷类型和配置卷大小

<!-- -->

-   安装监控和自动化代理的方式与vSphere的Windows模板相同

-   Windows用户名: 输入需要设置的Windows管理员用户名

-   验证类型：密钥对、密码两种类型，选择密码

-   Windows密码：设置用户名对应的密码

2.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新。

此时这个Windows
2012的操作系统，关联了2个虚拟机模板。在[服务配置](https://cloudchef.github.io/doc/AdminDoc/05服务建模/服务配置.html)的时候，平台会自动选择与该服务相对应的虚拟机模板，无需重复设置。

### 添加一个Hyper-V虚拟机模板

3.  在虚拟机模板页面，点击「添加」，输入虚拟机模板名称，选择HyperV云平台名称，并对虚拟机模板做如下配置：

-   基本信息：选择「操作系统名称」、描述、和系统类型（按需求选择Linux和Windows，这里选择Windows）

-   模板：选择Windows 2012模板

-   编辑虚拟机模板：输入模板名称、云平台入口、模板中已启用WinRM：勾选该选项，表示模板中已经启用和配置WinRM，可以选择通过WinRM的方式安装监控代理和自动化代理

-   监控方式：

<!-- -->

-   无监控：不安装监控代理，则平台的监控功能不可用

-   WinRM安装监控代理：会通过WinRM的方式访问虚拟机并安装监控代理设置监控端口，默认是9182

<!-- -->

-   安装自动化代理：

<!-- -->

-   不安装：若不安装自动化代理，则平台的一些自动化功能将无法使用，例如蓝图带应用部署或添加磁盘，某些虚拟机的操作如重置密码，执行脚本等等

-   WinRM安装：选择WinRM安装，会通过WinRM的方式访问虚拟机并安装自动化代理

<!-- -->

-   用户名：输入需要设置的用户名，例如: root

-   密码：输入需要设置的管理员密码,例如：Passw0rd

4.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新

 ### 添加一个Azure虚拟机模板

<!-- -->

1.  在虚拟机模板页面，点击「添加」，输入虚拟机模板名称，选择Azure云平台名称，并对虚拟机模板做如下配置：

-   基本信息：选择「操作系统名称」、描述、和系统类型（按需求选择Linux和Windows，这里选择Windows）

-   编辑虚拟机模板：输入模板名称、Azure的云平台入口、选择区域名称（例如：中国北部）、镜像名称（勾选允许修改时，在服务配置种可以修改镜像）

-   监控方式：

<!-- -->

-   无监控：不安装监控代理，则平台的监控功能不可用

-   WinRM安装监控代理：会通过WinRM的方式访问虚拟机并安装监控代理设置监控端口，默认是9182

-   云平台监控：从Azure上直接读取虚机的监控数据，不需要安装监控代理

<!-- -->

-   安装自动化代理：

<!-- -->

-   不安装：若不安装自动化代理，则平台的一些自动化功能将无法使用，例如蓝图带应用部署或添加磁盘，某些虚拟机的操作如重置密码，执行脚本等等

-   WinRM安装：选择WinRM安装，会通过WinRM的方式访问虚拟机并安装自动化代理

<!-- -->

-   用户名：输入需要设置的用户名，例如: root

-   密码：输入需要设置的管理员密码,例如：Passw0rd

2.  点击「提交」，提示虚拟机模板已创建。点击「保存」，提示虚拟机模板已更新

# 查看当前虚拟机模板

您可以根据下面的步骤来查看虚拟机模板：

>「Note」请使用租户管理员或基础设施管理员角色登录SmartCMP平台。

1.  在左边导航选择「基础设施」，选择二级菜单「虚拟机模板」，则显示当前的虚拟机模板列表。可在列表中查看描述信息以及该虚拟机模板对应的操作系统类型

2.  点击虚拟机模板的名称可进入基本信息页面，可查看操作系统名称、描述、系统类型

3.  点击虚拟机模板，进入虚拟机模板管理界面。可新增、编辑和删除虚拟机模板