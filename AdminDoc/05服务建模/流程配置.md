
 **流程应用场景**

在云资源的自助化申请、审批、自动化部署、运维操作和手工工单处理过程中，流程定义了这些任务处理过程或服务配置过程的方法和策略。系统默认提供标准流程，同时支持管理员通过流程设计器定义灵活的各项服务所需的流程，对云主机的申请、运维操作、回收进行控制，对手工工单服务的处理、关闭进行管控，主要流程包括：审批、手工工单服务和云资源蓝图服务流程等等。

# 审批流程

SmartCMP支持租户管理员通过流程设计器自定义审批流程模板，自定义的具体配置包括审批的层级结构，审批员的指定，审批规则，以及可以执行的操作。

主要功能点

-   支持定义任意多级审批。

-   支持在流程设计器中图形化的设计审批的全过程。

-   支持定义按用户或角色进行审批。

-   支持定义审批时是否可以更改申请的配置。

-   支持在业务组和服务目录层面定义需要审批和通知的环节。

-   支持审批员批量操作审批

-   支持设置每一级审批员可以修改的字段

-   支持通过企业微信、钉钉审批，审批员可通过企业微信或钉钉收到审批消息通知，并在审批指定应用（在企业微信、钉钉中创建的第三方企业应用）完成审批流程。
    >「Note」 管理员需在「通知配置」中配置企业微信或钉钉的审批应用相关参数，具体请参考[通知配置](https://cloudchef.github.io/doc/AdminDoc/09系统管理/README.html#通知配置)

## 配置审批流程

SmartCMP配置审批流程有两种方法：

1.  一是业务组管理员或租户管理员在业务组配置中添加审批流程A

2.  二是业务组管理员或租户管理员在服务配置中添加审批流程B

>「Note」 当同时使用两种配置方法，审批流程发生冲突，服务配置中审批流程B优先于业务组配置中的审批流程A。

### 在业务组中添加审批流程

管理员可为业务组添加审批流程，配置成功后，业务组成员申请服务部署时，将需要通过审批模板中的流程进行控制。

1.  「组织架构」-「业务组」，点击业务组名称进入业务组详情页面

2.  在「审批流程」标签页，选择 审批模板，点击「保存」

3.  保存后，业务组成员申请服务时会进入审批流程

### 在服务配置中添加审批流程

在「服务目录」申请服务成功后，如果服务提前配置了审批流程，则服务将进入审批队列，获得审批模板中相关成员的审批意见。审批通过才能执行部署操作。

以在服务配置中为"vSphere单节点服务"添加审批流程及用户申请该服务为例：

1. 在「服务建模」-「服务配置」选择服务配置列表中的 "vSphere单节点服务"。

2. 点击服务名称，进入编辑服务页面，在「审批配置」页面中，选择审批流程（在服务配置过程中，审批流程的内容只能查看和选择任意一个流程，不能编辑和删除。）点击「保存」。保存后，申请该服务需要按照该模板的审批流程通过后才能部署。

3. 服务申请者点击左侧导航栏「服务目录」，选择"vSphere单节点服务"，点击进入服务申请页面。

4. 填写申请单：包括业务组（卡片共享给全部业务组时需要填写）、服务部署名称（若业务组未设置服务部署命名规则时需填写），部署数量，项目，所有者，部署原因、虚拟机模板等，填写完成后点击「申请」。

5. 查看申请状态：进入「服务请求」-「待审批」，申请状态为「待审批」状态。

6. 审批：审批模板中指定的审批人登入系统后进入「服务请求」-「待审批」，选择待审批的项目。
        >「Note」可选中多个待处理的审批，批量进行操作。

7. 输入审批意见，点击「批准」，弹出确认提示框，点击「是」。

8. 查看已审批通过的项目：进入「服务请求」-「已审批」，项目的状态是「审批通过」。

9. 申请者登入系统后进入「我的申请」里查看申请的蓝图部署状态变更为「审批通过」。「服务部署」里，项目已经开始部署。部署成功后，在「服务部署」中，选择该服务，可对服务进行被允许的运维操作。

## 自定义并行审批流程 {#自定义并行审批流程}

在左侧导航栏点击「服务建模」-「流程配置」，点击添加名称（并行审批流程）、描述、类别（审批流程）等信息之后，使用流程设计器设计和定义您需要启用的审批流程。
选中并行审批流程，进入「流程设计器」以图形化的方式自定义具体策略：
为您介绍流程设计器的使用方法：左边圆圈代表开始的节点，右边圆圈代表结束节点，并行审批流程设定两个平行审批环节（审批A环节、审批B环节），某申请通过A环节并且通过B环节则审批通过申请成功，两个环节任意一个环节不通过则申请失败。如图所示：

![流程](../../picture/Admin/flowable01.png)



1. 配置审批人
    + 审批人可以选择角色或用户。例如租户管理员、业务组管理员等，也可以指定某个用户作为审批人。
        审批流程中内置角色使用：如果希望审批能够从申请者所在的最底层组织架构开始审批，然后再是资源所在的业务组，为满足这样的审批流程，我们需要在审批流程中添加额外的审批角色。管理员编辑审批流程时，审批人选择「角色」，列出内置审批用角色分别是：
        「一级业务组管理员」：定义为用户所在的最底层业务组的管理员
        「二级业务组管理员」：定义为用户所在的上一层业务组的管理员
         例如：审批流程中添加两级审批流程，第一级角色选择"一级业务组管理员"，第二级角色选择"二级业务组管理员"。审批时可以从申请者资源所在业务组的最底层组织架构开始审批。
    + 审批人选择动态用户，指定“动态用户”${FORM.approver}，为服务自定义表单，在表单配置处绑定approver字段，实现您可以指定任意一个用户作为审批人的需求。
    + 审批人选择基于访问权限，则当这个流程用于部署或云资源操作审批时，只有对该资源有读取权限的用户才能收到审批请求。
2. 审批更改（允许或不允许审批员进行修改）高级配置（可配置审批员可以修改的具体字段，例如CPU、内存等）
3. 审批规则分为两种：第一种是固定值即满足设定数目的审批者则可通过该层级审批，如若有一人拒绝通过则审批失败。第二种为百分比即满足设定的百分比的成员通过此项审批则为通过，若有一人拒绝则审批失败。


对于具体的操作分为审批操作和执行操作：

审批操作是赋予该层级审批人审批的权限，即可以批准、拒绝或退回该申请。执行操作则没有审批权限，不能拒绝或退回，只是作为该层审批的审阅者查看申请内容并确认审批完成。此外，还可以对该层审批者定义是否具备修改申请的权限，如需，请勾选允许修改申请。


## 内置的审批流程 {#内置的审批流程}

系统内置租户管理员审批流程、业务组管理员审批流程、审批模板流程，方便用户直接选择所需要的审批流程。

内置的审批流程不可修改和删除，只支持查看和使用，用户自定义添加的审批流程支持修改和删除

-   「租户管理员审批」：定义为用户所在的租户系统内的管理员

-   「业务组管理员审批」：定义为用户所在的业务组的管理员

-   「审批模板流程」：内置的云服务部署审批流程


# 手工工单服务流程{#内置的手工工单服务流程}

手工工单服务流程定义工单任务具体的处理步骤、服务团队、服务人员和流转方式。

服务团队建立完成之后，通过服务配置创建工单，将工单发布到服务目录，完成服务卡片的发布和服务目录的管理。以下内容将为您详细介绍配置手工工单服务流程、配置手工工单服务和发布手工工单服务的具体步骤。

## 自定义添加手工工单服务流程

在左侧导航栏点击「服务建模」-「服务流程管理」，点击添加，输入名称（手工工单服务流程）、描述、选择类别（手工工单服务）、上传流程配置文件。

## 内置的手工工单服务流程

平台内置的手工工单服务流程包括标准手工工单，标准事件管理流程、自动化服务流程。

+ 标准事件管理流程，用来解决出现IT资源相关的问题，例如：服务器意外关闭，网络出现中断问题等等，网络IP地址冲突等等。流程类型属于手工工单服务。
+ 标准手工工单：需要IT人工介入的服务，例如：申请重新设置密码的手工工单服务。
+ 自动化服务流程：用户申请手工工单服务，服务通过审批之后，自动化创建用户申请的资源，例如：创建项目，创建IP池，等等。

>「Note」内置的手工工单服务流程，不支持修改和删除，只支持查看和使用，用户自定义添加的手工工单服务流程支持修改和删除



# 标准事件流程 Incident
Report，用来解决出现的IT资源相关的问题，例如服务器down了，网络IP地址冲突等等。流程类型属于手工工单服务。

具体流程如图：

![流程](../../picture/Admin/flowable02.png)

标准事件流程主要环节包括：一线处理支持、二线处理支持、关闭服务。

一线和二线的任务处理环节可以指定不同团队。一线处理支持收到事件之后，可以进行的操作如下：

-   直接处理，问题解决完成之后，填写问题或故障的原因或解决办法的说明

-   转派给其它服务团队

-   升级：升级到二线进行处理，并且填写升级说明

二线支持处理收到事件之后，可以进行的操作如下：

-   直接处理，问题解决完成之后，可以填写问题的原因和解决方法的说明

-   转派给其它团队

2.  邮件通知用户问题已经解决，当发起手工工单服务申请的用户收到问题解决的邮件之后，如果用户满意此次手工工单服务选择进行服务关闭则工单状态改变为「已处理」；如果用户选择将工单重新处理，则返回给上一级的处理人。（在邮件通知用户的上一步中谁处理的就返回给谁，二线处理的返回给二线，一线的返回给一线），工单状态改变为「处理中」

# 云资源蓝图服务流程{#内置的标准云服务部署流程}

内置的标准云服务部署流程 ：定义云资源自动化部署的流程，属于系统内置的云资源蓝图服务流程。
配置云资源蓝图服务流程，为满足不同服务项的服务流程要求，平台内置多种服务流程和自定义添加服务流程。系统管理员和租户管理员可以进入「配置管理」-「服务流程配置」页面，进行添加、查看、流程设计、启用、禁用、编辑和删除流程模板的操作，下文为您介绍具体操作步骤。

>「Note」内置的服务流程不支持编辑、流程设计、启用、禁用、删除操作，具体的内置流程详细信息请参考：[流程应用场景](https://cloudchef.github.io/doc/AdminDoc/05服务建模/流程配置.html)


1.  在左侧导航栏点击「服务建模」-「流程配置」，点击「添加」按钮

2.  进入新增流程页面，输入自定义流程的基本信息：流程名称、描述、类别（云资源蓝图服务、手工工单服务和审批流程三种类型），保存名称、类别等信息之后可使用流程设计器设计和定义您需要启用的流程。点击保存按钮，自定义服务流程创建成功。

为您介绍创建基础流程图的方法：左边圆圈代表开始的节点，右边圆圈代表结束节点，工单任务处理流程之后可以自定义任务一、自定义任务二、或其余的自定义任务。如图所示：


![流程](../../picture/Admin/flowable03.png)


# 标准任务执行流程
内置的标准任务执行流程：定义任务自动化执行的流程，具体的任务类型包括：蓝图部署任务、云资源任务、Jenkins任务、脚本任务、等待任务等等。通过服务配置，配置服务具体的类型，以及绑定标准任务执行流程，配置完成后发布到服务目录，通过申请服务卡片来直接执行一个任务。


![标准任务执行流程](../../picture/Admin/flowable04.png)





# 编辑、删除服务流程

在左侧导航栏点击「服务建模」-「流程配置」选中一个流程，点击「编辑」-「流程设计」直接进入服务流程设计器的UI，显示process的流程，以可视化的方式更改设计流程图。

>「Note」选中的流程必须是自定义添加的流程，系统内置的流程不支持流程设计

在左侧导航栏点击「服务建模」-「服务流程管理」，选择一个服务流程，点击「删除」按钮，弹出删除提示框点击「是」，提示删除服务流程成功。

>「Note」当流程定义正在某一个服务配置中使用时，删除服务流程失败

# 启用、禁用服务流程

在左侧导航栏点击「服务建模」-「服务流程管理」，选择一个服务流程，点击「启用」按钮，即可启用该服务流程。

在左侧导航栏点击「服务建模」-「服务流程管理」，选择一个服务流程，点击「禁用」按钮，即可禁止使用该服务流程。

>「Note」系统默认的流程主要有两种：标准云服务部署和标准手工工单。这两种内置流程默认启用，不可以禁用、修改或者删除。
