**流水线作业**

# 功能描述

云平台的流水线作业功能，集成DevOps工具链，结合组件库、蓝图和高度自定义的阶段和任务来构建，实现自动执行资源和软件的交付过程。构建代码，运行测试（CI），部署和更新应用程序的新版本（CD）。消除了人为错误，为开发人员提供了标准化的反馈循环，并实现了快速的产品迭代。

流水线由一系列阶段构成，每个阶段由软件在发布到生产之前必须完成的多个任务和环境组成。目前支持多种阶段和任务的自定义和组装，能够在阶段中添加任意数量的执行任务，通过它们已经可以设计出各种场景适用的开发、部署、运维流水线。帮助用户建设自动化的、可重复利用、安全合规的应用持续交付和部署。实现应用的测试、部署、更新、运维、回收的的全生命周期管理。

# 流水线的组成部分

+ 阶段：指根据业务的需要，定义不同的阶段，在每个阶段中定义需要完成的任务。例如，可定义软件打包、部署测试环境等不同的阶段。
+ 任务：具体执行的活动。支持自定义任务类型、输入输出参数，其中输入输出参数指云平台支持流水线各个任务之间传递的参数，例如将上一个任务新部署的虚拟机ID传给下一个任务进行调用。流水线的发布者可以定义每个任务的资源和参数，在后续的任务中进行调用。其中， 每个阶段的任务类型包括：
    + 等待任务，定义间隔时间，在执行时等待。在输入参数处填写等待时间（s）。
    + 蓝图部署任务，在作业执行时部署新的云资源，在输入参数处填写服务（服务目录中发布的服务）和模板。
    + Jenkins任务，执行Jenkins上已有的Job，配置Jenkins的端点和Job，自定义构建软件包。
    + 选择云资源运维任务，对指定的云资源执行运维操作，例如启停、快速执行脚本、添加白名单等。
    + 制品库解析任务，解析二进制制品库中的软件制品包版本。

+ 触发器: 自定义流水线的触发条件，触发器定义何时自动运行流水线，可以手动触发流水线任务，也可以设定策略由触发器自动触发流水线任务。触发器类型包括：Webhook集成(支持Git，Gitlab等代码仓库改变触发)、Jenkins触发、定时触发、手工触发等等。



# 流水线详细的配置步骤

以下面这个场景为例：自动构建+制品库解析+应用升级更新，例如：开发人员提交代码，触发Jenkins自动化构建，上传最新的War包到制品仓库存储最新的镜像包，再通过制品库解析任务获取最新应用包的仓库地址，最终自动化更新环境下的镜像包。
![流水线作业](../../picture/Admin/流水线作业.png)

## 创建流水线

1. 在左侧导航栏点击「作业管理」-「流水线作业」，点击创建流水线。
2. 在基本信息页面输入名称、描述、绑定一个项目（该项目的成员可以申请执行流水线）、通知到用户(流水线开始执行，结束执行时会发送通知给指定用户，前提是管理员在系统管理-通知配置界面，已对接完成消息通知平台，配置细节请参考，[通知配置](https://cloudchef.github.io/doc/AdminDoc/09系统管理/#通知配置))。
3. 可添加全局参数，在后期任务中进行调用。在基本信息页面，参数列表处，点击加号按钮，填写名称“Branch”，值“master”。
    ![创建流水线](../../picture/Admin/devops01.png)


## 配置阶段
创建完成流水线作业，添加完成基本信息之后，进行流水线作业的阶段配置：
1. 在左侧导航栏点击「作业管理」-「流水线作业」-「流程」，点击添加按钮。
2. 输入阶段名称，例如，Jenkins构建，解析软件包，更新应用环境等阶段。
    ![配置阶段](../../picture/Admin/配置阶段.png)

## 配置任务{#配置任务}

### 添加Jenkins任务
创建完成Jenkins构建阶段之后，再点击「添加串行任务」按钮。在Jenkins任务添加详情界面：
1. 基本信息选择Jenkins任务，开发人员向master分支提交代码，调用在基本信息界面配置的全局参数，分支为master时，触发Jenkins自动同步开发环境下master分支上的最新代码。
2. 在输入参数处填写仓库入口（选择在入口处添加提前配置的Jekins仓库，具体配置步骤，请参考 [添加Jenkins入口的步骤](https://cloudchef.github.io/doc/AdminDoc/11作业管理/#添加Jenkins入口的步骤) ），选择在Jenkins上已有的Job（这些Job任务，由这个Jenkins账号所有者，在Jenkins后台按需创建完成。）

    ![jenkins入口与任务关联](../../picture/Admin/jenkins入口与任务关联.png)   
    
3. 选择属性文件，实际上是自定义Jenkins任务的输出的配置参数，属性文件的具体内容会写入任务的输出结果。
4. 勾选选择等待结果，指当前Jenkins任务输出结果完成之后，再进行下一阶段，不勾选，则即使输出结果不成功，也不会影响任务执行。 
5. 执行设置内填写超时时间（例如：设置超时时间为360s，该任务执行时间超过360s代表任务执行失败）。执行选项（选择失败后继续执行表示当前任务失败继续执行下一个任务，或选择失败后结束流程表示当前任务失败结束该流水线流程，流水线执行失败）。 执行方式（选择默认执行，或选择条件执行时需要设置条件执行表达式，例如：您可以输入EL表达式，可参考下图：

    ![执行配置](../../picture/Admin/devops02.png)

### 添加制品库解析任务
在Jenkins任务执行完成之后，将构建的新镜像保存到Harbor中，并通过制品库解析任务，获取最新版本镜像，用新镜像更新应用环境。其中，需要创建制品库解析任务，解析Harbor制品库中的软件制品包的地址，以获取最新的镜像包升级应用环境。在制品库解析任务添加详情界面：
1. 基本信息选择制品库解析任务，名称填写从Harbor获取相应最新版本的镜像。
2. 输入参数：选择制品库入口，注意，入口需要提前配置，具体配置步骤，请参考 [添加制品库](https://cloudchef.github.io/doc/AdminDoc/06云服务管理/制品库.html) ，仓库支持在任务执行时选择：不指定仓库，任务执行时才灵活选择；从上下文中获取：依赖于上下文的仓库参数，需要填写获取的表达式 （需要能够显示上个任务输出的仓库参数，也需要能够引用上个任务所选择的所有仓库参数）；默认值：对接Harbor制品仓库时，选择成功了一个制品库入口，会默认填入其余的相关参数。
3. 制品库解析输出参数，仓库：镜像包所在的仓库；组：镜像包所在的组；名称：获取的镜像包名称；版本：镜像包的版本；下载地址：镜像包的下载地址。   
    
除了以上详细介绍的这两种典型的任务，云平台还支持创建更多类型的任务，例如：在服务部署+运维一体化的应用场景下，当云主机部署成功之后，获取云主机的ID，等待10秒，再针对单个/多个云主机，执行配置好的运维脚本。

### 添加蓝图部署任务
选择蓝图部署任务，在作业执行时部署新的云主机， 以在vSphere云平台部署云主机为例，可选择的服务类型来源于服务目录中已发布的服务卡片，可选择的模板来源于，服务申请时保存申请信息的模板，具体步骤：
1. 基本信息选择蓝图部署任务。
2. 点击左侧导航栏「服务目录」-「选择在vSphere云平台部署云主机的服务项」，进入「请求服务详情页面」，填写申请参数，点击下方「保存」按钮，定义模板名称，保存成功即可形成模板。
3. 在蓝图部署任务添加详情界面，选择刚刚创建成功de1模板。

### 添加等待任务
等待任务，定义间隔时间，在执行时等待。在输入参数处填写等待时间（s），例如：在等待10s之后，流水线再自动执行运维脚本。

### 添加云资源运维任务
选择云资源运维任务，对刚刚部署成功的云主机资源执行运维操作，例如对云主机批量启停、执行运维脚本并查看结果，具体步骤：
1. 基本信息选择云资源运维任务。
2. 在树形结构中，选择云资源类型 Resource-IaaS-Machine,则指定运维操作脚本将应用于IaaS分组下多个类型的云主机。
3. 选择方式，选择已有云资源，则 可选择的云资源来源于平台已纳管的云资源（云资源具体查看步骤：点击左侧导航栏「我的部署」-「云资源」，选择云资源类型，可查看已纳管的IaaS分组下的Machine）。
4. 还可以从上下文中选择，云资源运维任务依赖于此任务之前的蓝图部署任务， 支持在云资源的下拉框中选择全局参数或上下文的传参，例如，下图中，之前任务的输出参数，选择vSphere Server下的machineids，选中部署成功的所有vSphere云主机的ID。
![选择参数和资源](../../picture/Admin/选择参数和资源.png)
5. 在操作详情，关联已经配置完成的运维脚本，脚本的配置步骤，请参考[添加脚本](https://cloudchef.github.io/doc/AdminDoc/11作业关联/脚本库.html)
6. 输出参数中可以了解当前云资源运维任务下执行的云资源ID，所有成功执行完成本任务的云资源ID，所有执行本任务失败的云资源ID，并且具体输出哪些参数，支持按需自定义。
   

 
## 配置触发器

自定义流水线的触发条件，触发器定义何时自动运行流水线，可以手动触发流水线任务，也可以设定策略由触发器自动触发流水线任务。SmartCMP触发器类型包括：Webhook集成(支持Git，Gitlab等代码仓库改变触发)、Jenkins触发、定时触发、手工触发(即手动执行流水线作业时触发)等等。

### 添加定时触发器
添加定时触发器的具体步骤：
1. 输入触发器名称填写定时触发器、类型选择CRON、描述(选填) 。
2. 配置CRON的详细参数，选择重复的类型（自定义cron表达式 例如：0 0 0 * * ？、每周某天的某个时段、每月某天的某个时段、每天的某个时段）。
3. 点击创建即可配置完成触发器。例如：每天/每周/每月的10点10分执行生成快照的操作。


### 添加Webhook触发器
添加配置一个Webhook类型的触发器（当代码提交到Gitlab代码仓库时触发）。当提交代码到Gitlab代码仓库时，仓库状态发生改变，触发流水线。具体步骤：
1. 在左侧导航栏点击「作业管理」-「流水线作业」，点击创建，在触发器页面点击创建。
2. 输入触发器名称、类型选择WEBHOOK、描述(选填)，WEBHOOK详细参数配置如下图 
3. 以Gitlab为例，在流水线详情中添加一个webhook类型的触发器。在 "来源" 中自定义字段，例如：下图的"gitlab-test"，"gitlab-test"会自动拼接到"URL"，形成完整的网址链接。注意：这个完整的URL（ http：//SmartCMP地址/ops-listener/webhook/gitlab-test ），  在Gitlab中配置时要用到。
4. 添加过滤条件，过滤条件的作用相当于密码验证。当管理员不配置过滤条件时，只要调用这个URL（http：//SmartCMP地址/ops-listener/webhook/Gitlab-test ），就会触发流水线操作。添加过滤条件后，相当于给"webhook trigger"添加了密码。
5. 当回调URL时，只有密码匹配成功才能触发流水线操作。如果只支持Gitlab，Gitlee和Git，过滤条件只需要设置密码就可以生效，采用键值对的方式是为了兼容更多的场景。所以添加过滤条件时，如果回调方是Gitlab，Gitlee和Git，“名称”要固定写token，“值”支持自定义（输入password）。配置完毕后依次保存。
![触发器](../../picture/Admin/trigger.png)

6. Gitlab具体配置步骤：打开Gitlab，如果Gitlab是新申请的环境，要调整下network配置，允许请求从本地回调。
![Gitlab配置](../../picture/Admin/Gitlab01.png)

 >「Note」  配置webhook，创建一个project，进入project详情，依次点开Setting–Integrations，在URL中输入WEBHOOK参数配置中提前设置的URL地址(http：//SmartCMP地址/ops-listener/webhook/gitlab-test) ，在Secret Token中输入"条件过滤" 中配置的token对应的值(自定义的值password)，注意，不要勾选Enable SSL verification 去掉，选择 Add Webhook，将实现当有代码提交时会触发流水线的功能。
   



