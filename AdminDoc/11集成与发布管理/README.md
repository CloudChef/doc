**持续发布与部署**

SmartCMP的应用持续发布和部署，通过软件组件、蓝图和在全新引进的流水线来构建：
+	定义应用软件：接入主流的制品仓库对软件组件进行存放管理和版本控制，软件组件关联制品仓库并自定义应用的部署方式和相关参数。
+	定义应用服务：通过蓝图建模，编排应用架构；通过服务配置，指定资源参数和相关应用的版本。
+	定义流水线：配置流水线的阶段和多种类型的任务，实现应用的测试、部署、更新、运维、回收的的全生命周期管理。



![持续发布与部署](../../picture/Admin/持续发布和部署.png)

下面为您介绍具体的配置步骤。


# 制品管理
SmartCMP配置应用软件，通过接入主流的制品仓库对软件组件进行存放管理和版本控制，软件组件关联制品仓库并自定义应用的部署方式和相关参数。
制品仓库管理是对软件研发过程中生成的产物的管理， 制品一般作为最终交付物完成发布和交付。所有的制品包，依赖组件均能够纳入制品库中统一管理。


+ 制品仓库在SmartCMP平台中是通过入口来接入的，具体的操作步骤，请参考，
[入口](#入口)  

+ SmartCMP支持通过软件组件功能实现定义应用软件，将制品仓库与软件组件关联，制品仓库对软件组件进行存放关联和版本控制管理。

软件组件与主流制品库关联，具体的操作步骤如下：

1.  在软件组件列表点击软件名称，进入组件视图包含「基本信息」「属性」「文件列表」「生命周期」「历史版本」「制品」
2. 在「制品」视图，您可以选择 端点、仓库（Nexus）、组、名称、版本。
3. 点击保存按钮，即可将组件与包管理平台进行关联。


+ 定义应用服务，在服务配置中，配置软件组件的节点详细参数。

配置软件组件的节点详细参数，具体的操作步骤如下：

1. 在左边导航选择「服务建模」-「服务配置」，出现服务列表,列表中显示服务名称，点击服务名称，进入详细配置视图，点击「组件配置」，选择软件组件
2. 「节点详细设置」视图，配置软件组件节点的组、名称、版本

## 入口{#入口}
入口可以添加需要连接的软件制品仓库，为将要使用的软件组件提供部署时的制品来源，定义了软件包或任务调度的对接。流水线中执行归档或镜像推送操作的程序包，会统一存放一份在制品仓库中，支持在入口处接入Nexus等等制品仓库管理平台。
具体步骤：
1. 在左侧导航栏点击「集成与发布」-「入口」，
+ 点击添加Nexus入口，输入名称、地址、用户名、密码，
+ 点击添加Jekins入口，输入名称、地址，类型选择密码使输入用户名、密码；选择令牌时输入用户名和令牌。

2. 点击验证、验证通过，点击提交即可接入软件制品仓库。



# 流水线

SmartCMP的流水线，能够帮助用户建设自动化的、可重复利用、安全合规的应用持续交付和部署。流水线由一系列阶段构成，每个阶段由软件在发布到生产之前必须完成的多个任务和环境组成。目前支持多种阶段和任务的自定义和组装，能够在阶段中添加任意数量的执行任务，通过它们已经可以设计出各种场景适用的开发、部署、运维流水线。
+	新增流水线，绑定一个项目，并可添加全局参数，在后期任务中进行调用。具体步骤：
1.  在左侧导航栏点击「集成与发布」-「流水线」，点击创建，在基本信息页面输入名称、描述、项目、通知到用户
2. 设置自定义属性，点击添加按钮，输入名称、值、描述，点击创建即可
3. 当您创建流水线完成之后， 在左侧导航栏点击「集成与发布」-「流水线」，可二次编辑、删除、执行、禁用、锁定流水线。



## 配置触发器

自定义流水线的触发条件，触发器定义何时自动运行流水线，可以手动触发流水线任务，也可以设定策略由触发器自动触发流水线任务。SmartCMP触发器类型包括：Webhook集成(支持Git，Gitlab等代码仓库改变触发)、Jenkins触发、定时触发、手工触发等等。
具体步骤：

1.  在左侧导航栏点击「集成与发布」-「流水线」，点击创建，在触发器页面点击创建，
2. 输入触发器名称、类型、描述
3. 点击创建即可配置完成触发器

## 配置阶段和任务{#配置阶段和任务} 

可根据业务的需要，定义不同的阶段，在每个阶段中定义需要完成的任务。

+ 例如，可定义软件打包、部署测试环境等不同的阶段。每个阶段的任务类型包括：Jenkins Job 任务、部署新应用任务、云资源变更任务、脚本执行任务等等。流水线的发布者可以定义每个任务的参数，在后续的任务中进行调用。

任务指具体执行的活动。支持自定义任务类型、输入输出参数，其中输入输出参数指SmartCMP支持流水线各个任务之间的参数传递，例如将上一个任务新部署虚拟机的IP地址传给下一个任务进行调用。

+ 例如，通过一个蓝图部署任务，即可以自动化触发一个已发布的云资源服务，进行云资源的部署；而云资源任务则可以自动化进行云资源变更、运维操作，进行应用软件的升级、更新。

设计流水的阶段和任务的具体步骤：

1. 在左侧导航栏点击「集成与发布」-「流水线」，点击创建，在流程页面点击添加按钮，输入阶段名称，点击添加
2. 点击添加串行任务，在任务的详情页填写：任务类型、名称、描述、通知到用户，填写输入参数，自定义输出参数（任务类型不同，输入输出参数相应变化）
    + 选择等待任务，在输入参数处填写等待时间（s）
    + 选择蓝图部署任务，在输入参数处填写服务（服务目录中发布的服务）和模板
    + Jenkins任务，在输入参数处填写仓库入口，任务类型，选择是否等待结果，如果不稳定时，标记为成功继续继续还是标记为失败，结束执行
    + 选择云资源任务，在输入参数处选择已有云资源，云资源类型、操作（云资源的day2运维操作包括挂载，调整磁盘配置等等）

3. 执行设置内填写超时时间、执行选项（选择失败后继续执行或失败后结束流程）、执行方式（选择默认执行或条件执行）


## 查看流水线的执行历史
通过执行历史可以查看执行状态、执行人、执行时间、每个阶段任务执行的详细信息。
1. 在左侧导航栏点击「集成与发布」-「执行历史」，可根据筛选条件（项目、状态、起止时间）快速定位流水线。
2. 点击流水线，可查看流水执行状态（进行中、成功、失败）、执行人信息、开始时间、结束时间、耗时、流水线完整的可视化的流程图。



